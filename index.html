<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Prototype - Campus Grievance Portal</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --border-color: #dee2e6;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --success-bg: #e8f5e9;
            --success-color: #388e3c;
            --review-bg: #fffbe6;
            --review-color: #b28c00;
            --ai-feature-bg: #f0f8ff;
            --ai-feature-border: #cce5ff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            min-height: 100vh;
            margin: 0;
            box-sizing: border-box;
        }
        .prototype-container {
            width: 100%;
            max-width: 1200px;
            background-color: #fff;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .screen-header {
            padding: 1rem 1.5rem;
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.2rem;
            text-align: center;
        }
        .screen-content {
            padding: 1.5rem;
        }
        .screen { display: none; }
        .screen.active { display: block; }

        /* Form & Button Elements */
        input[type="text"], input[type="password"], input[type="email"], textarea, select, input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0 1rem 0;
            border: 1px solid var(--border-color);
            background-color: #fff;
            border-radius: 6px;
            box-sizing: border-box;
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .lofi-button {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border-color);
            background-color: #fff;
            color: var(--text-color);
            cursor: pointer;
            text-align: center;
            margin-right: 1rem;
            margin-top: 1rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
            box-sizing: border-box; /* Added for consistent width calculation */
        }
        .lofi-button:hover { background-color: var(--background-color); border-color: #c8ced3; }
        .lofi-button.primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }
        .lofi-button.primary:hover { background-color: var(--primary-hover-color); border-color: var(--primary-hover-color); }
        .lofi-button.full-width { 
            width: 100%; 
            display: block;
            margin-right: 0; /* Reset margin for full width buttons */
        }
        .lofi-link {
            cursor: pointer;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
        }
        .lofi-link:hover { text-decoration: underline; }
        .lofi-label { display: block; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.25rem; }
        
        /* Layout & Cards */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .lofi-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .lofi-card.clickable:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; border-color: #c8ced3; }
        .lofi-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .lofi-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
        }
        .lofi-status.resolved { background-color: var(--success-bg); color: var(--success-color); border-color: var(--success-color);}
        .lofi-status.review { background-color: var(--review-bg); color: var(--review-color); border-color: var(--review-color);}
        .lofi-status.assigned { background-color: #eef7ff; color: #007bff; border-color: #007bff;}
        
        /* Table */
        .table-responsive-wrapper {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .lofi-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .lofi-table th, .lofi-table td { border-bottom: 1px solid var(--border-color); padding: 1rem; text-align: left; white-space: nowrap; }
        .lofi-table th { background-color: var(--background-color); font-size: 0.9rem; color: var(--text-muted-color); }
        .lofi-table tr:hover { background-color: var(--background-color); }
        .lofi-table td small { color: var(--text-muted-color); }

        /* Modal, Timeline, FAQ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;}
        .modal-close { font-size: 1.5rem; cursor: pointer; border: none; background: none; color: #888; }
        .lofi-timeline { margin-top: 1.5rem; }
        .lofi-timeline-item { padding-left: 1.5rem; border-left: 2px solid var(--border-color); position: relative; padding-bottom: 2rem; }
        .lofi-timeline-item:last-child { padding-bottom: 0; }
        .lofi-timeline-item::before { content: ''; position: absolute; left: -9px; top: 5px; width: 16px; height: 16px; border-radius: 50%; background-color: #fff; border: 2px solid var(--border-color); }
        .lofi-timeline-item.active::before { border-color: var(--primary-color); background-color: var(--primary-color); }
        .faq-item { border-bottom: 1px solid var(--border-color); padding: 1rem 0; }
        .faq-item summary { font-weight: 600; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        .faq-item summary::-webkit-details-marker { display: none; }
        .faq-item summary::after { content: '+'; font-size: 1.5rem; }
        .faq-item[open] summary::after { content: 'âˆ’'; }
        .faq-item p { margin-top: 1rem; line-height: 1.6; color: var(--text-muted-color); }

        /* AI Feature Styles */
        .ai-summary-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--ai-feature-bg);
            border: 1px solid var(--ai-feature-border);
            border-radius: 6px;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .prototype-container {
                border-radius: 0;
                border: none;
                min-height: 100vh;
            }
            .screen-content {
                padding: 1rem;
            }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .dashboard-header h2 {
                font-size: 1.5rem;
            }
            .lofi-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <div class="prototype-container">

        <div id="login-screen" class="screen active">
            <!-- Login Screen Content -->
              <div class="screen-header">Campus Grievance Portal</div>
              <div class="screen-content">
                  <div class="form-container" style="max-width: 400px; margin: 0 auto; text-align: center;">
                      <img src="https://placehold.co/100x100/007bff/ffffff?text=UoP" 
                           onerror="this.onerror=null;this.src='https://placehold.co/100x100/cccccc/ffffff?text=Error'" 
                           alt="University Logo" 
                           style="margin-bottom: 1.5rem; border-radius: 50%; width: 100px; height: 100px; object-fit: cover;">
                      <h2>Portal Login</h2>
                      <label class="lofi-label" for="login-id" style="text-align: left;">Student / Staff ID</label>
                      <input type="text" id="login-id" placeholder="Enter your ID">
                      <label class="lofi-label" for="login-pass" style="text-align: left;">Password</label>
                      <input type="password" id="login-pass" placeholder="Enter your password">
                      <div class="lofi-button primary full-width" onclick="login('student')">Login as Student (Jane Doe)</div>
                      <div class="lofi-button full-width" onclick="login('admin')">Login as Admin</div>
                  </div>
              </div>
        </div>

        <div id="student-dashboard-screen" class="screen">
            <!-- Student Dashboard Content -->
            <div class="screen-header">Student Dashboard</div>
            <div class="screen-content">
                <div class="dashboard-header">
                    <h2 id="student-welcome-message"></h2>
                    <div>
                         <span class="lofi-link" onclick="navigateTo('faq-screen')">Help/FAQ</span>
                         <span class="lofi-link" style="margin-left: 1.5rem;" onclick="logout()">Logout</span>
                    </div>
                </div>
                <div class="lofi-button primary" onclick="navigateTo('submit-form-screen')">+ Submit New Grievance</div>
                <h3 style="margin-top: 2.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">Active Grievances</h3>
                <div id="student-active-grievances"><p style="color: var(--text-muted-color);">You have no active grievances.</p></div>
                <h3 style="margin-top: 2.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">Resolved Grievances</h3>
                <div id="student-resolved-grievances"><p style="color: var(--text-muted-color);">You have no resolved grievances.</p></div>
            </div>
        </div>
        
        <div id="submit-form-screen" class="screen">
            <!-- Submit Form Screen Content -->
            <div class="screen-header">Submit a New Grievance</div>
            <div class="screen-content">
                <label class="lofi-label" for="category">Grievance Category</label>
                <select id="category">
                    <option value="">Select a category...</option>
                    <option value="Academic">Academic</option>
                    <option value="Administrative">Administrative</option>
                    <option value="Facilities">Facilities</option>
                    <option value="Hostel">Hostel</option>
                    <option value="Library">Library</option>
                    <option value="IT Services">IT Services</option>
                    <option value="Finance/Fees">Finance/Fees</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Safety & Security">Safety & Security</option>
                    <option value="Harassment">Harassment</option>
                    <option value="Other">Other</option>
                </select>
                <label class="lofi-label" for="title">Title</label>
                <input type="text" id="title" placeholder="e.g., Incorrect grade awarded for final exam">
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label class="lofi-label" for="description">Detailed Description</label>
                    <div class="lofi-button" id="ai-write-btn" onclick="handleAiWrite(this)">âœ¨ Help Me Write This</div>
                </div>
                <textarea id="description" rows="5" placeholder="Describe your issue in detail, or provide a title and click 'Help Me Write This'."></textarea>
                
                <label class="lofi-label">Upload Supporting Files (Optional)</label>
                <input type="file" style="margin-top: 0.5rem;">
                <div style="margin: 1.5rem 0; display:flex; align-items:center;"><input type="checkbox" id="anon" style="width: auto; height: 1rem; margin-right: 0.5rem;"><label for="anon" style="font-weight:normal; margin:0;">Submit Anonymously</label></div>
                <div class="lofi-button primary" onclick="submitNewGrievance()">Submit Grievance</div>
                <div class="lofi-button" onclick="goBackToDashboard()">Go Back</div>
            </div>
        </div>

        <div id="confirmation-screen" class="screen">
            <!-- Confirmation Screen Content -->
            <div class="screen-header">Submission Successful</div>
            <div class="screen-content" style="text-align: center; padding: 4rem 2rem;">
                <h1 style="font-size: 4rem; color: var(--success-color); border:none;">âœ“</h1>
                <h2>Grievance Submitted!</h2>
                <p>Your reference number is: <strong id="new-grievance-id"></strong></p>
                <p style="margin-top: 2rem; color: var(--text-muted-color);">You can track the status of this grievance from your dashboard.</p>
                <div class="lofi-button primary" onclick="navigateTo('student-dashboard-screen')">Back to Dashboard</div>
            </div>
        </div>

        <div id="tracking-screen" class="screen">
            <!-- Tracking Screen Content -->
              <div class="screen-header">Track Grievance</div>
              <div class="screen-content">
                  <div class="dashboard-header">
                      <h2 id="tracking-id-header"></h2>
                      <div class="lofi-button" onclick="goBackToDashboard()">Go Back</div>
                  </div>
                  <div class="lofi-card">
                      <p><strong>Title:</strong> <span id="tracking-title"></span></p>
                      <p><strong>Category:</strong> <span id="tracking-category"></span></p>
                      <p><strong>Status:</strong> <span id="tracking-status" class="lofi-status"></span></p>
                      <p><strong>Submitted:</strong> <span id="tracking-date"></span> by <span id="tracking-submitter"></span></p>
                      <strong style="display:block; margin-top:1rem;">Description:</strong>
                      <p id="tracking-description" style="white-space: pre-wrap; margin-top:0.5rem; color: var(--text-muted-color);"></p>
                  </div>
                  <h3 style="margin-top: 2.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">Status Timeline</h3>
                  <div class="lofi-timeline" id="tracking-timeline"></div>
              </div>
        </div>

        <div id="admin-dashboard-screen" class="screen">
            <!-- Admin Dashboard Content -->
            <div class="screen-header">Admin Dashboard</div>
            <div class="screen-content">
                 <div class="dashboard-header">
                    <h2>All Grievances</h2>
                    <span class="lofi-link" onclick="logout()">Logout</span>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <strong>Filter by:</strong>
                    <select id="filter-status" onchange="applyFilters()" style="margin:0;"><option value="All">Status: All</option><option value="New">Status: New</option><option value="Resolved">Status: Resolved</option></select>
                    <select id="filter-category" onchange="applyFilters()" style="margin:0;">
                        <option value="All">Category: All</option>
                        <option value="Academic">Academic</option>
                        <option value="Administrative">Administrative</option>
                        <option value="Facilities">Facilities</option>
                        <option value="Hostel">Hostel</option>
                        <option value="Library">Library</option>
                        <option value="IT Services">IT Services</option>
                        <option value="Finance/Fees">Finance/Fees</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Safety & Security">Safety & Security</option>
                        <option value="Harassment">Harassment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="table-responsive-wrapper">
                    <table class="lofi-table">
                        <thead><tr><th>ID</th><th>Title</th><th>Category</th><th>Submitter</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="admin-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="faq-screen" class="screen">
            <!-- FAQ Screen Content -->
            <div class="screen-header">Help & Frequently Asked Questions</div>
            <div class="screen-content">
                <div class="dashboard-header">
                    <h2>FAQs</h2>
                    <div class="lofi-button" onclick="goBackToDashboard()">Go Back</div>
                </div>
                <div class="faq-list">
                    <details class="faq-item">
                        <summary>How do I submit a grievance?</summary>
                        <p>From your student dashboard, click the "+ Submit New Grievance" button. Fill in all the required fields, including category, title, and a detailed description. You can also upload supporting documents if needed.</p>
                    </details>
                    <details class="faq-item">
                        <summary>Is my submission anonymous?</summary>
                        <p>You have the option to submit your grievance anonymously by checking the "Submit Anonymously" box on the form. If you choose this option, your personal details will be hidden from the initial reviewers.</p>
                    </details>
                    <details class="faq-item">
                        <summary>What happens after I submit my grievance?</summary>
                        <p>Once submitted, your grievance is assigned a unique ID and routed to the relevant department (e.g., Academics, Facilities). You can track its status and see all updates on the "Track Grievance" page accessible from your dashboard.</p>
                    </details>
                    <details class="faq-item">
                        <summary>How long will it take to resolve my issue?</summary>
                        <p>Resolution times vary. Simple facilities requests may be resolved within 48 hours, while complex academic issues may take up to 14 working days. You will see status updates in the tracking timeline.</p>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Details Modal -->
    <div id="admin-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-grievance-id"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // --- UTILITY FUNCTIONS ---
        function showAlert(message, type = 'error') {
            const alertBox = document.createElement('div');
            alertBox.style.position = 'fixed';
            alertBox.style.top = '20px';
            alertBox.style.right = '20px';
            alertBox.style.padding = '1rem 1.5rem';
            alertBox.style.borderRadius = '8px';
            alertBox.style.color = '#fff';
            alertBox.style.zIndex = '2000';
            alertBox.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            alertBox.style.opacity = '0';
            alertBox.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            alertBox.style.transform = 'translateX(20px)';

            alertBox.style.backgroundColor = (type === 'error') ? '#dc3545' : '#28a745';
            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.style.opacity = '1';
                alertBox.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    if (alertBox.parentNode) {
                        alertBox.parentNode.removeChild(alertBox);
                    }
                }, 300);
            }, 3000);
        }

        // --- DATA STORE & SESSION ---
        let currentUser = null;
        let grievances = [
            { id: 'GRV-12345', title: 'Incorrect Grade in Quantum Physics II', category: 'Academic', submittedBy: '10210456', submitterName: 'Jane Doe', email: 'jane.doe@university.edu', description: 'I believe my final grade in PHYS401 was calculated incorrectly. I received a B+ but my scores on all exams and assignments should equate to an A-.', date: '2025-09-12', status: 'Under Review', isAnonymous: false, history: [{ status: 'Under Review', date: '2025-09-13', notes: 'Assigned to the Academic Council.'}, { status: 'Submitted', date: '2025-09-12', notes: 'Grievance submitted.'}] },
            { id: 'GRV-12344', title: 'Faulty Wi-Fi in Library Building', category: 'Facilities', submittedBy: '20310222', submitterName: 'Mark Smith', email: 'mark.smith@university.edu', description: 'The Wi-Fi on the 3rd floor of the main library has been unstable for the past week, making it impossible to study.', date: '2025-09-10', status: 'New', isAnonymous: false, history: [{ status: 'Submitted', date: '2025-09-10', notes: 'Grievance submitted.'}] },
            { id: 'GRV-12301', title: 'Hostel Room Change Request', category: 'Hostel', submittedBy: '10210456', submitterName: 'Jane Doe', email: 'jane.doe@university.edu', description: 'Requesting a room change due to persistent noise issues with my current roommate.', date: '2025-09-01', status: 'Resolved', isAnonymous: false, history: [{ status: 'Resolved', date: '2025-09-05', notes: 'Room change approved and processed.'}, { status: 'Submitted', date: '2025-09-01', notes: 'Grievance submitted.'}]},
            { id: 'GRV-12343', title: 'Misconduct during lecture', category: 'Academic', submittedBy: 'Anonymous', submitterName: 'Anonymous', email: null, description: 'A professor made inappropriate comments during the lecture on Monday.', date: '2025-09-09', status: 'New', isAnonymous: true, history: [{ status: 'Submitted', date: '2025-09-09', notes: 'Grievance submitted.'}] }
        ];

        // --- GEMINI API SIMULATION ---
        async function callGeminiApi(prompt) {
            console.log("Calling Gemini API with prompt:", prompt);
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
            if (prompt.includes("Summarize")) {
                return `Key points from the grievance:
- The user is reporting that the Wi-Fi on the 3rd floor of the main library is unstable.
- This has been an issue for the past week.
- The problem is preventing the user from studying effectively.`;
            } else if (prompt.includes("Write a formal")) {
                const title = prompt.split("'")[1];
                return `To Whom It May Concern,

I am writing to formally report an issue regarding "${title}". 

[Please add specific details here, such as dates, times, locations, and any individuals involved.]

This situation has caused [explain the impact on you, e.g., disruption to my studies, a safety concern, etc.], and I would appreciate your prompt attention to this matter.

I believe a suitable resolution would be [suggest a desired outcome if you have one].

Thank you for your time and consideration. I look forward to hearing about the steps that will be taken to address this grievance.

Sincerely,
${currentUser.name}`;
            }
            return "Sorry, I couldn't process that request.";
        }

        async function handleAiWrite(button) {
            const title = document.getElementById('title').value;
            if (!title) { showAlert("Please enter a title for your grievance first."); return; }
            const descriptionBox = document.getElementById('description');
            button.innerHTML = "âœ¨ Generating..."; button.disabled = true;
            const prompt = `You are a helpful assistant for a university student. Write a formal and detailed grievance description based on the following title. Be clear, concise, and professional. The title is: '${title}'`;
            descriptionBox.value = await callGeminiApi(prompt);
            button.innerHTML = "âœ¨ Help Me Write This"; button.disabled = false;
        }

        async function handleAiSummarize(button, grievanceId) {
            const grievance = grievances.find(g => g.id === grievanceId);
            if (!grievance) return;
            button.innerHTML = "âœ¨ Summarizing..."; button.disabled = true;
            const prompt = `Summarize the following student grievance into 2-3 key bullet points for an administrator to review quickly. Grievance: '${grievance.description}'`;
            const result = await callGeminiApi(prompt);
            const summaryContainer = document.getElementById('ai-summary-container');
            summaryContainer.innerHTML = `<strong>âœ¨ AI Summary:</strong><p style="white-space: pre-wrap; margin-top:0.5rem;">${result}</p>`;
            summaryContainer.style.display = 'block';
            button.innerHTML = "âœ¨ Generate Summary"; button.disabled = false;
        }

        // --- CORE APP LOGIC ---
        function login(role) {
            if (role === 'student') {
                currentUser = { id: '10210456', name: 'Jane Doe', role: 'student', email: 'jane.doe@university.edu' };
                navigateTo('student-dashboard-screen');
            } else {
                currentUser = { id: 'admin01', name: 'Admin', role: 'admin' };
                navigateTo('admin-dashboard-screen');
            }
        }
        function logout() { currentUser = null; navigateTo('login-screen'); }

        function navigateTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
            if (currentUser) {
                if (screenId === 'student-dashboard-screen') renderStudentDashboard();
                if (screenId === 'admin-dashboard-screen') applyFilters();
            }
        }

        function goBackToDashboard() {
            navigateTo(currentUser.role === 'admin' ? 'admin-dashboard-screen' : 'student-dashboard-screen');
        }
        
        function renderStudentDashboard() {
            document.getElementById('student-welcome-message').textContent = `Welcome, ${currentUser.name}!`;
            const userGrievances = grievances.filter(g => g.submittedBy === currentUser.id);
            const activeContainer = document.getElementById('student-active-grievances');
            const resolvedContainer = document.getElementById('student-resolved-grievances');
            activeContainer.innerHTML = ''; resolvedContainer.innerHTML = '';
            
            const active = userGrievances.filter(g => g.status !== 'Resolved').sort((a, b) => new Date(b.date) - new Date(a.date));
            const resolved = userGrievances.filter(g => g.status === 'Resolved').sort((a, b) => new Date(b.date) - new Date(a.date));

            if(active.length) active.forEach(g => activeContainer.appendChild(createGrievanceCard(g)));
            else activeContainer.innerHTML = `<p style="color: var(--text-muted-color);">You have no active grievances.</p>`;
            
            if(resolved.length) resolved.forEach(g => resolvedContainer.appendChild(createGrievanceCard(g)));
            else resolvedContainer.innerHTML = `<p style="color: var(--text-muted-color);">You have no resolved grievances.</p>`;
        }

        function getStatusClass(status) {
            if (status === 'Resolved') return 'resolved';
            if (status.includes('Review')) return 'review';
            if (status.includes('Assigned')) return 'assigned';
            return '';
        }

        function createGrievanceCard(g) {
            const card = document.createElement('div');
            card.className = 'lofi-card clickable';
            card.onclick = () => navigateToTrackingPage(g.id);
            const statusClass = getStatusClass(g.status);
            card.innerHTML = `<div class="lofi-card-header"><span>${g.title}</span><span class="lofi-status ${statusClass}">${g.status}</span></div><div>ID: ${g.id} | Submitted: ${g.date}</div>`;
            return card;
        }
        
        function submitNewGrievance() {
            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const isAnonymous = document.getElementById('anon').checked;

            if (!title || !category || !description) { showAlert('Title, Category, and Description are required.'); return; }
            
            const newGrievance = {
                id: `GRV-${Math.floor(10000 + Math.random() * 90000)}`,
                title, category, description, isAnonymous,
                submittedBy: isAnonymous ? 'Anonymous' : currentUser.id,
                submitterName: isAnonymous ? 'Anonymous' : currentUser.name,
                email: isAnonymous ? null : currentUser.email,
                date: new Date().toISOString().split('T')[0],
                status: 'New',
                history: [{ status: 'Submitted', date: new Date().toISOString().split('T')[0], notes: 'Grievance submitted.' }]
            };
            grievances.unshift(newGrievance);
            
            document.getElementById('new-grievance-id').textContent = newGrievance.id;
            document.getElementById('submit-form-screen').querySelectorAll('input[type="text"], textarea, select').forEach(el => el.value = '');
            document.getElementById('anon').checked = false;
            navigateTo('confirmation-screen');
        }

        function navigateToTrackingPage(id) {
            const g = grievances.find(item => item.id === id);
            if (!g) return;
            
            document.getElementById('tracking-id-header').textContent = `Grievance ${g.id}`;
            document.getElementById('tracking-title').textContent = g.title;
            document.getElementById('tracking-category').textContent = g.category;
            document.getElementById('tracking-date').textContent = g.date;
            document.getElementById('tracking-submitter').textContent = g.isAnonymous ? 'Anonymous' : g.submitterName;
            document.getElementById('tracking-description').textContent = g.description;
            
            const statusEl = document.getElementById('tracking-status');
            statusEl.textContent = g.status;
            statusEl.className = `lofi-status ${getStatusClass(g.status)}`;

            const timelineEl = document.getElementById('tracking-timeline');
            timelineEl.innerHTML = '';
            g.history.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = index === 0 ? 'lofi-timeline-item active' : 'lofi-timeline-item';
                itemEl.innerHTML = `<strong>${item.status}</strong><div style="color:var(--text-muted-color); font-size:0.9rem;">Date: ${item.date}</div><div>${item.notes}</div>`;
                timelineEl.appendChild(itemEl);
            });
            navigateTo('tracking-screen');
        }

        function renderAdminTable(data) {
            const tableBody = document.getElementById('admin-table-body');
            tableBody.innerHTML = '';
            if(!data.length) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 2rem; color: var(--text-muted-color);">No grievances match the current filter.</td></tr>`;
                return;
            }
            const sortedData = data.sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedData.forEach(g => {
                const row = tableBody.insertRow();
                const statusClass = getStatusClass(g.status);
                const submitterInfo = g.isAnonymous ? 'Anonymous' : `${g.submitterName}<br><small>${g.email}</small>`;
                row.innerHTML = `
                    <td>${g.id}</td><td>${g.title}</td><td>${g.category}</td><td>${submitterInfo}</td>
                    <td>${g.date}</td><td><span class="lofi-status ${statusClass}">${g.status}</span></td>
                    <td><div class="lofi-link" onclick="viewGrievanceDetails('${g.id}')">View / Action</div></td>`;
            });
        }

        function applyFilters() {
            const status = document.getElementById('filter-status').value;
            const category = document.getElementById('filter-category').value;
            let filtered = grievances;
            if (status !== 'All') filtered = filtered.filter(g => g.status === status);
            if (category !== 'All') filtered = filtered.filter(g => g.category === category);
            renderAdminTable(filtered);
        }

        function updateGrievanceStatus(id, newStatus, notes = '') {
            const g = grievances.find(item => item.id === id);
            if (!g) return;
            g.status = newStatus;
            g.history.unshift({ status: newStatus, date: new Date().toISOString().split('T')[0], notes: notes || `Status updated to ${newStatus}.` });
            closeModal();
            applyFilters();
        }
        
        function viewGrievanceDetails(id) {
            const g = grievances.find(item => item.id === id);
            document.getElementById('modal-grievance-id').textContent = `Details for ${id}`;
            const body = document.getElementById('modal-body');
            const submitterInfo = g.isAnonymous ? 'Anonymous' : `${g.submitterName} (<a href="mailto:${g.email}">${g.email}</a>)`;
            body.innerHTML = `
                <p><strong>Title:</strong> ${g.title}</p>
                <p><strong>Submitted By:</strong> ${submitterInfo}</p>
                <p><strong>Status:</strong> ${g.status}</p>
                <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <strong>Description:</strong>
                    <div class="lofi-button" id="ai-summarize-btn" onclick="handleAiSummarize(this, '${id}')">âœ¨ Generate Summary</div>
                </div>
                <div id="ai-summary-container" style="display:none;" class="ai-summary-container"></div>
                <div class="lofi-card" style="white-space: pre-wrap; background-color: var(--background-color); margin-top:0.5rem;">${g.description}</div>
                <h4 style="margin-top:1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">Actions</h4>
                <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                    <div class="lofi-button" onclick="updateGrievanceStatus('${id}', 'Assigned to Academics', 'Forwarded to Academic Council.')">Assign to Academics</div>
                    <div class="lofi-button" onclick="updateGrievanceStatus('${id}', 'Assigned to Facilities', 'Forwarded to Facilities Dept.')">Assign to Facilities</div>
                    <div class="lofi-button" onclick="updateGrievanceStatus('${id}', 'Under Review', 'Grievance is under review by the committee.')">Mark as Under Review</div>
                    <div class="lofi-button primary" onclick="updateGrievanceStatus('${id}', 'Resolved', 'The issue has been marked as resolved by the admin.')">Mark as Resolved</div>
                    <div class="lofi-button" onclick="closeModal()">Back</div>
                </div>`;
            document.getElementById('admin-details-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('admin-details-modal').style.display = 'none'; }

        document.addEventListener('DOMContentLoaded', () => navigateTo('login-screen'));
    </script>
</body>
</html>
